{% extends "base.html" %}
{% load crispy_forms_filters %}
{% csrf_token %}

{% block content %}

<div class="d-flex">
  <h1>Sample schema</h1>
  <a href="{% url 'schemas:schema-edit' pk=schema.id %}" class="link-primary text-decoration-none mt-auto mb-auto ms-3">Edit schemas</a>
</div>

{% if schema.columns.all %}
  <table class="table-bordered table">
    <tr>
      <th>#</th>
      <th>Column name</th>
      <th>Column type</th>
    </tr>
      {% for column in schema.columns.all %}
        <tr>
          <td>{{ column.id }}</td>
          <td>{{ column.name }}</td>
          <td>{{ column.data_type }}</td>
        </tr>
      {% endfor %}
  </table>
{% else %}
  <p>No columns found.</p>
{% endif %}
<div class="d-flex">
 <h2>Generated Data:</h2>
  <form id="generate-data-form" method="POST" class="ms-auto d-inline-flex align-items-center justify-content-center">
    {% csrf_token %}
    <div class="me-2">{{ form }}</div>
    <button type="submit" id="generate-csv-btn" class="btn btn-success">Generate Data</button>
  </form>
</div>
{% if schema.columns.all %}
  <div class="datasets-container">
    <table class="table-bordered table">
      <tbody id="datasets-container">
        <tr>
        <th>#</th>
        <th>Created</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
      {% for dataset in schema.datasets.all %}
        <tr>
          <td>{{ dataset.id }}</td>
          <td>{{ dataset.created_at }}</td>
          <td class="file-status">{{ dataset.status }}</td>
          {% if dataset.file %}
            <td><a href={{ dataset.file.url }}>Download</a></td>
          {% else %}
            <td class="url-update"></td>
          {% endif %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<script>
// Create a function to update the dataset status and file URL in the table
function updateDataset(datasetId, status, fileUrl) {
  // Find the row with the dataset ID
  const row = document.querySelector(`tr[data-id="${datasetId}"]`);
  console.log(row)

  // Update the status cell
  const statusCell = row.querySelector('.status');
  console.log(statusCell)
  statusCell.textContent = status;

  // Update the file URL cell
  const fileUrlCell = row.querySelector('.url-update');
  const fileUrlLink = document.createElement('a');
  fileUrlLink.href = fileUrl;
  fileUrlLink.textContent = 'Download';
  fileUrlCell.textContent = '';
  fileUrlCell.appendChild(fileUrlLink);
}

// Add an event listener to the generate CSV button
const generateCsvBtn = document.querySelector('#generate-csv-btn');
generateCsvBtn.addEventListener('click', (event) => {
  event.preventDefault();
  generateCsvBtn.disabled = true;

  // Send the form data to the view to create a new dataset instance
  const form = document.querySelector('#generate-data-form');
  const dataset = new FormData(form);
  fetch(form.action, {
    method: 'POST',
    body: dataset
  })
  .then((response) => response.json())
  .then((data) => {
    // Add a new row to the table with the dataset information
    const row = document.createElement('tr');
    row.setAttribute('data-id', data.id);

    const idCell = document.createElement('td');
    idCell.textContent = data.id;
    row.appendChild(idCell);

    const createdAtCell = document.createElement('td');
    createdAtCell.textContent = data.created_at;
    row.appendChild(createdAtCell);

    const statusCell = document.createElement('td');
    statusCell.setAttribute("class", "status")
    statusCell.textContent = data.status;
    row.appendChild(statusCell);

    const linkCell = document.createElement('td');
    linkCell.setAttribute("class", "url-update")
    row.appendChild(linkCell);

    const tableBody = document.querySelector('#datasets-container');
    tableBody.appendChild(row);

    // Send a second POST request to update the dataset status and file URL
    fetch(`/datasets/${data.id}/update/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
    .then((response) => response.json())
    .then((fetched_data) => {

      updateDataset(fetched_data.id, fetched_data.status, fetched_data.file_url);
      generateCsvBtn.disabled = false;
    });
  });
});

</script>

{% endblock %}